<div id="day3" class="day-content">
    <h2>üìò Day 3: Error Handling & Status Codes</h2>

    <div class="objectives">
        <h3>üéØ Learning Objectives</h3>
        <ul>
            <li>Master HTTP status codes and when to use each</li>
            <li>Implement consistent error response formats</li>
            <li>Create centralized error handling middleware</li>
            <li>Handle validation errors gracefully</li>
            <li>Implement proper error logging</li>
        </ul>
    </div>

    <h3>üìö HTTP Status Codes Reference</h3>

    <table>
        <thead>
            <tr>
                <th>Code</th>
                <th>Name</th>
                <th>When to Use</th>
            </tr>
        </thead>
        <tbody>
            <tr><td>200</td><td>OK</td><td>Successful GET, PUT, PATCH</td></tr>
            <tr><td>201</td><td>Created</td><td>Successful POST that creates resource</td></tr>
            <tr><td>204</td><td>No Content</td><td>Successful DELETE (no body)</td></tr>
            <tr><td>400</td><td>Bad Request</td><td>Invalid syntax, validation error</td></tr>
            <tr><td>401</td><td>Unauthorized</td><td>Authentication required/failed</td></tr>
            <tr><td>403</td><td>Forbidden</td><td>Authenticated but not permitted</td></tr>
            <tr><td>404</td><td>Not Found</td><td>Resource doesn't exist</td></tr>
            <tr><td>409</td><td>Conflict</td><td>Resource conflict (duplicate)</td></tr>
            <tr><td>422</td><td>Unprocessable</td><td>Valid syntax but semantic error</td></tr>
            <tr><td>500</td><td>Server Error</td><td>Unexpected server error</td></tr>
        </tbody>
    </table>

    <h3>üíª Code Examples</h3>

    <h4>1. Consistent Error Response Format</h4>
    <div class="code-block">
        <div class="code-header">
            <span>JavaScript - Error Response Structure</span>
            <button class="copy-btn" onclick="copyCode(this, 'code-d3-1')">Copy</button>
        </div>
        <pre><code id="code-d3-1">// Custom Error class for API errors
class ApiError extends Error {
    constructor(statusCode, message, details = null) {
        super(message);
        this.statusCode = statusCode;
        this.details = details;
        this.timestamp = new Date().toISOString();
    }

    toJSON() {
        return {
            error: {
                status: this.statusCode,
                message: this.message,
                details: this.details,
                timestamp: this.timestamp
            }
        };
    }
}

// Factory functions for common errors
const Errors = {
    notFound: (resource) => new ApiError(404, `${resource} not found`),
    badRequest: (message, details) => new ApiError(400, message, details),
    unauthorized: () => new ApiError(401, 'Authentication required'),
    forbidden: () => new ApiError(403, 'You do not have permission'),
    conflict: (message) => new ApiError(409, message),
    validation: (errors) => new ApiError(422, 'Validation failed', errors),
    internal: () => new ApiError(500, 'Internal server error')
};

module.exports = { ApiError, Errors };
</code></pre>
    </div>

    <h4>2. Centralized Error Handling Middleware</h4>
    <div class="code-block">
        <div class="code-header">
            <span>JavaScript - Error Middleware</span>
            <button class="copy-btn" onclick="copyCode(this, 'code-d3-2')">Copy</button>
        </div>
        <pre><code id="code-d3-2">const express = require('express');
const app = express();
app.use(express.json());

// Custom error class
class ApiError extends Error {
    constructor(statusCode, message, details = null) {
        super(message);
        this.statusCode = statusCode;
        this.details = details;
    }
}

// Sample data
let users = [{ id: 1, name: 'Alice', email: 'alice@example.com' }];

// Routes with proper error throwing
app.get('/api/users/:id', (req, res, next) => {
    try {
        const id = parseInt(req.params.id);
        if (isNaN(id)) {
            throw new ApiError(400, 'Invalid user ID format');
        }
        const user = users.find(u => u.id === id);
        if (!user) {
            throw new ApiError(404, 'User not found');
        }
        res.json(user);
    } catch (error) {
        next(error); // Pass to error handler
    }
});

app.post('/api/users', (req, res, next) => {
    try {
        const { name, email } = req.body;
        const errors = [];

        if (!name || name.trim().length < 2) {
            errors.push({ field: 'name', message: 'Name must be at least 2 characters' });
        }
        if (!email || !email.includes('@')) {
            errors.push({ field: 'email', message: 'Valid email required' });
        }
        if (users.find(u => u.email === email)) {
            throw new ApiError(409, 'Email already exists');
        }

        if (errors.length > 0) {
            throw new ApiError(422, 'Validation failed', errors);
        }

        const newUser = { id: users.length + 1, name, email };
        users.push(newUser);
        res.status(201).json(newUser);
    } catch (error) {
        next(error);
    }
});

// 404 handler for undefined routes
app.use((req, res, next) => {
    next(new ApiError(404, `Route ${req.method} ${req.path} not found`));
});

// Global error handler (MUST be last middleware)
app.use((error, req, res, next) => {
    console.error(`[${new Date().toISOString()}] Error:`, error.message);

    const statusCode = error.statusCode || 500;
    const response = {
        error: {
            status: statusCode,
            message: error.message || 'Internal server error',
            ...(error.details && { details: error.details }),
            path: req.path,
            timestamp: new Date().toISOString()
        }
    };

    // Don't expose internal errors in production
    if (statusCode === 500 && process.env.NODE_ENV === 'production') {
        response.error.message = 'Internal server error';
    }

    res.status(statusCode).json(response);
});

app.listen(3000, () => console.log('Server running'));
</code></pre>
    </div>

    <div class="storage-demo">
        <h4>üíæ localStorage Practical: Error Log Dashboard</h4>
        <p>Track and analyze API errors for debugging:</p>
        <div class="code-block">
            <div class="code-header">
                <span>JavaScript - Error Logger</span>
                <button class="copy-btn" onclick="copyCode(this, 'storage-d3')">Copy</button>
            </div>
            <pre><code id="storage-d3">// Error Log Dashboard - Track API errors
const ERROR_LOG_KEY = 'day3_error_log';
const MAX_LOGS = 100;

// Log an error
function logError(statusCode, message, endpoint) {
    const logs = JSON.parse(localStorage.getItem(ERROR_LOG_KEY)) || [];
    logs.unshift({
        id: Date.now(),
        statusCode,
        message,
        endpoint,
        timestamp: new Date().toISOString()
    });
    // Keep only last 100 errors
    if (logs.length > MAX_LOGS) logs.pop();
    localStorage.setItem(ERROR_LOG_KEY, JSON.stringify(logs));
}

// Get error statistics
function getErrorStats() {
    const logs = JSON.parse(localStorage.getItem(ERROR_LOG_KEY)) || [];
    const stats = {
        total: logs.length,
        byStatusCode: {},
        byEndpoint: {},
        last24h: 0
    };

    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);

    logs.forEach(log => {
        stats.byStatusCode[log.statusCode] = (stats.byStatusCode[log.statusCode] || 0) + 1;
        stats.byEndpoint[log.endpoint] = (stats.byEndpoint[log.endpoint] || 0) + 1;
        if (new Date(log.timestamp).getTime() > oneDayAgo) stats.last24h++;
    });

    return stats;
}

// Get recent errors
function getRecentErrors(count = 10) {
    const logs = JSON.parse(localStorage.getItem(ERROR_LOG_KEY)) || [];
    return logs.slice(0, count);
}

// Clear old errors
function clearErrors() {
    localStorage.removeItem(ERROR_LOG_KEY);
    console.log('üóëÔ∏è Error logs cleared');
}

// Usage
logError(404, 'User not found', '/api/users/999');
logError(400, 'Invalid email format', '/api/users');
logError(500, 'Database connection failed', '/api/orders');
console.log('Stats:', getErrorStats());
console.table(getRecentErrors(5));
</code></pre>
        </div>
    </div>

    <div class="exercise">
        <h4>üèãÔ∏è Exercise: Build Robust Error Handling</h4>
        <p><strong>Task:</strong> Create a products API with comprehensive error handling.</p>
        <ul>
            <li>Return 400 for invalid price (must be positive number)</li>
            <li>Return 404 for non-existent products</li>
            <li>Return 409 for duplicate product names</li>
            <li>Return 422 for missing required fields</li>
        </ul>

        <details>
            <summary>‚úÖ Solution</summary>
            <div class="code-block">
                <div class="code-header">
                    <span>JavaScript - Products with Error Handling</span>
                    <button class="copy-btn" onclick="copyCode(this, 'solution-d3')">Copy</button>
                </div>
                <pre><code id="solution-d3">const express = require('express');
const app = express();
app.use(express.json());

class ApiError extends Error {
    constructor(statusCode, message, details) {
        super(message);
        this.statusCode = statusCode;
        this.details = details;
    }
}

let products = [{ id: 1, name: 'Laptop', price: 999 }];

app.post('/api/products', (req, res, next) => {
    try {
        const { name, price } = req.body;
        const errors = [];

        if (!name) errors.push({ field: 'name', message: 'Name is required' });
        if (price === undefined) errors.push({ field: 'price', message: 'Price is required' });
        if (errors.length) throw new ApiError(422, 'Validation failed', errors);

        if (typeof price !== 'number' || price <= 0) {
            throw new ApiError(400, 'Price must be a positive number');
        }

        if (products.find(p => p.name.toLowerCase() === name.toLowerCase())) {
            throw new ApiError(409, 'Product with this name already exists');
        }

        const product = { id: products.length + 1, name, price };
        products.push(product);
        res.status(201).json(product);
    } catch (error) {
        next(error);
    }
});

app.use((err, req, res, next) => {
    res.status(err.statusCode || 500).json({
        error: { status: err.statusCode, message: err.message, details: err.details }
    });
});

app.listen(3000);
</code></pre>
            </div>
        </details>
    </div>

    <div class="quiz">
        <h3>‚úÖ Check Your Knowledge</h3>

        <div class="quiz-question">
            <p><strong>Q1:</strong> What status code indicates the client sent invalid data?</p>
            <div class="quiz-options">
                <label><input type="radio" name="d3q1" value="a"> A) 401 Unauthorized</label>
                <label><input type="radio" name="d3q1" value="b"> B) 400 Bad Request</label>
                <label><input type="radio" name="d3q1" value="c"> C) 404 Not Found</label>
            </div>
            <button class="check-answer" onclick="checkAnswer('d3q1', 'b', 'd3q1-fb')">Check Answer</button>
            <div class="feedback" id="d3q1-fb"></div>
        </div>

        <div class="quiz-question">
            <p><strong>Q2:</strong> When should you return 409 Conflict?</p>
            <div class="quiz-options">
                <label><input type="radio" name="d3q2" value="a"> A) User not authenticated</label>
                <label><input type="radio" name="d3q2" value="b"> B) Resource doesn't exist</label>
                <label><input type="radio" name="d3q2" value="c"> C) Duplicate resource (e.g., email exists)</label>
            </div>
            <button class="check-answer" onclick="checkAnswer('d3q2', 'c', 'd3q2-fb')">Check Answer</button>
            <div class="feedback" id="d3q2-fb"></div>
        </div>
    </div>

    <div class="takeaways">
        <h3>üéØ Key Takeaways</h3>
        <ul>
            <li>Use appropriate status codes: 4xx for client errors, 5xx for server errors</li>
            <li>Create consistent error response format across your API</li>
            <li>Centralize error handling with middleware</li>
            <li>Never expose internal errors to clients in production</li>
        </ul>
        <p><strong>Tomorrow:</strong> Authentication & Authorization - JWT, API keys, and protecting routes.</p>
    </div>

    <button class="complete-day" onclick="completeDay(3)">‚úì Mark Day 3 Complete</button>
</div>
